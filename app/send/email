#!/usr/bin/env bash
set -Eeuo pipefail

ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P )";
source "$ROOT/../load.sh";
unset -v ROOT;

report="${1}";

reporter=$( app reporters.common );

subject=$( app $reporter.subject );
password=$( app $reporter.password );
from=$( app $reporter.from );
to=$( app $reporter.to );

smtp_host=$( app $reporter.host );
smtp_port=$( app $reporter.port );

email="$DESICCANT_PWD/.temporary_email";

now=$( now );
year=$( year );

header="
From: "$from"
To: "$to"
Subject: "$subject"

Automatically generated report $now.
";

footer="

********  Thanks for using DESICCANT   *******

You are free and more than welcome to support this project in any way you find convenient.
Desiccant is designed developped and provided for free as in freedom by hitch.fr, but it takes a lot of time, effort and money to build and maintain such a tool. You can just send a message to support@hitch.fr or open an issue to our official public repository in order to give us some feedback, propose improvement or tell us about potential security issues that you've found.

This report is generated by Desiccant, a dehydrated automation engine.
SENDER SCRIPT BY hitch.fr
Copyleft !Â© hitch.fr - $year
";

function body() {
	echo "$header" | sed 1d > "$email";
	echo "" | sed 1d >> "$email";
  echo '---------------------' | sed 1d >> "$email";
	echo "" | sed 1d >> "$email";
	cat "$report" | sed 1d >> "$email";
  echo "" | sed 1d >> "$email";
  echo '---------------------' | sed 1d >> "$email";
	echo "" | sed 1d >> "$email";
	echo "$footer" | sed 1d >> "$email";
}

function send() {

  curl --ssl-reqd \
    --url $smtp_host:$smtp_port \
    --user $from:$password \
    --mail-from $from \
    --mail-rcpt $to \
    --upload-file $email \
    &> /dev/null;

  if [ -f $email ]; 
  then
     rm $email;
  fi

}

body;
send;

unset -v subject;
unset -v password;
unset -v from;
unset -v to;
unset -v smtp_host;
unset -v smtp_port;
unset -v logdir;
unset -v logfile;
unset -v report;
unset -v reporter;
unset -v email;
unset -v now;
unset -v year;
unset -v header;
unset -v footer;